# 多模型API使用說明

## 🎯 功能概述

您的API現在已經成功修改，支援處理包含多個模型結果的Excel檔案。系統會自動偵測檔案中的模型數量，並為每個模型生成獨立的工作表。

## ✨ 新功能特點

### 1. 智能模型偵測
- 自動識別Excel檔案中的模型區塊
- 支援模型關鍵字: `gemini`, `gemma`, `chatgpt`, `claude`, `gpt`, `llama`, `palm`, `bard`
- 智能識別header行和資料行

### 2. 多工作表輸出
- 每個模型生成獨立的工作表
- 工作表名稱使用模型名稱
- 內容格式與原本完全一致

### 3. 向下相容
- 單模型檔案維持原有處理方式
- 原有API端點和格式不變

## 📋 API 端點

### POST /evaluate
上傳Excel檔案進行準確度評估

**請求:**
- Content-Type: `multipart/form-data`
- 檔案欄位: `file`
- 支援格式: `.xlsx`, `.xls`

**回應:**
- 單模型: 原有格式的Excel檔案
- 多模型: 包含多個工作表的Excel檔案

## 📊 資料格式要求

### 多模型Excel檔案格式:

```
第1行: gemini-2.5-pro
第2行: 編號  受編  障礙等級  障礙類別  ICD診斷  備註  障礙等級  證明/手冊  障礙類別  ICD診斷
第3行: 1     ZA001 輕度     其他類    [...]    []    輕度     身心障礙證明  其他類    [...]
第4行: 2     ZA002 中度     第1類     [...]    []    中度     身心障礙證明  第1類     [...]

第5行: (空行)

第6行: gemma3:27b
第7行: 編號  受編  障礙等級  障礙類別  ICD診斷  備註  障礙等級  證明/手冊  障礙類別  ICD診斷
第8行: 1     ZA001 輕度     其他類    [...]    []    中度     身心障礙證明  第2類     [...]
第9行: 2     ZA002 中度     第1類     [...]    []    輕度     身心障礙證明  其他類    [...]
```

## 📈 輸出格式

### 多模型輸出Excel檔案包含:

#### 工作表1: "gemini-2.5-pro"
```
A1: 模型          B1: gemini-2.5-pro    C1: (空)
A2: 受編          B2: 欄位              C2: 準確度
A3: ZA001         B3: (空)              C3: (空)
A4: (空)          B4: 障礙等級           C4: 100.0%
A5: (空)          B5: 障礙類別           C5: 85.5%
A6: (空)          B6: ICD診斷           C6: 90.2%
A7: (空)          B7: 整體準確度         C7: 91.9%
A8: (空)          B8: --- 分隔線 ---     C8: (空)
...
```

#### 工作表2: "gemma3:27b"
```
(相同格式，但資料為gemma3模型的結果)
```

## 🚀 使用步驟

### 1. 啟動API服務
```bash
cd /Users/cfh00896102/Github/feedback-judge
source .venv/bin/activate
python -m api.app
```

### 2. 發送評估請求
```bash
curl -X POST "http://localhost:8000/evaluate" \
     -F "file=@your_multi_model_file.xlsx" \
     --output result.xlsx
```

### 3. 檢查結果
下載的Excel檔案將包含:
- 單模型: 1個工作表 (原有格式)
- 多模型: 多個工作表 (每個模型一個)

## 🔧 技術實作細節

### 修改的檔案:
1. `api/evaluator_service.py` - 新增多模型分割邏輯
2. `api/excel_generator.py` - 新增多工作表生成功能
3. `api/app.py` - 修正import路徑

### 核心方法:
- `split_models_from_dataframe()` - 模型分割
- `_process_multiple_models()` - 多模型處理
- `generate_multi_model_excel()` - 多工作表生成

## ⚠️ 注意事項

1. **模型名稱識別**: 模型名稱需包含關鍵字才能被正確識別
2. **資料完整性**: 每個模型區塊需包含完整的header和資料行
3. **欄位對應**: 系統使用智能欄位映射，確保欄位名稱一致性
4. **錯誤處理**: 如果某個模型處理失敗，其他模型仍會繼續處理

## 🎉 完成!

您的API現在完全支援多模型分析，同時保持了原有功能的完整性。無論上傳單模型還是多模型檔案，系統都會自動適配並生成相應格式的結果。
